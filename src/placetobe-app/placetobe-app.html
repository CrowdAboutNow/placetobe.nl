<link
  rel="import"
  href="../../bower_components/polymer/polymer.html"
>

<link
  rel="import"
  href="../../bower_components/app-route/app-location.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-route/placetobe-route.html"
>

<link
  rel="import"
  href="../../bower_components/app-metadata/app-metadata.html"
  async
>

<link
  rel="import"
  href="../../bower_components/google-analytics-tracker/google-analytics-tracker.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-styles/placetobe-styles.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-behaviors/placetobe-styles-behavior.html"
>

<link
  rel="import"
  href="../../bower_components/iron-pages/iron-pages.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-hero/placetobe-hero.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-button/placetobe-button.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-header/placetobe-header.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-footer/placetobe-footer.html"
>

<dom-module id="placetobe-app">
  <template>

    <style>

      :host {
        --placetobe-color--general: var(--placetobe-color-gray);
        --placetobe-color--entrepreneurs: var(--placetobe-color-yellow);
        --placetobe-color--investors: var(--placetobe-color-taupe);
      }

      :host placetobe-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 9;
      }

      :host placetobe-hero {
        height: 0;
        min-height: calc( var(--placetobe-margin) * 26 );
      }

      @media(min-width: 601px) {
        :host placetobe-hero {
          min-height: 60vh;
        }
      }

      #hero-wrapper {
        overflow: hidden;
        height: 0;
        min-height: calc( var(--placetobe-margin) * 26 );
        transition: 0.6s min-height;
        transform: translate3d(0,0,0);
      }

      @media(min-width: 601px) {
        :host #hero-wrapper {
          min-height: 60vh;
        }
      }

      #hero-wrapper[hidden] {
        min-height: 0;
        display: block;
      }

      placetobe-hero[car-parked] {
        --placetobe-hero-color: var(--placetobe-color-taupe);
      }

      placetobe-hero[car-gone] {
        --placetobe-hero-color: var(--placetobe-color-yellow);
      }
    </style>

    <google-analytics-tracker
      tracking-id="[[analyticsTrackingId]]"
    ></google-analytics-tracker>

    <app-location
      route="{{route}}"
      path="{{locationPath}}"
    ></app-location>

    <placetobe-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
    ></placetobe-route>

    <placetobe-header
      location-path="{{locationPath}}"
      collapsed="[[headerCollapsed]]"
      current-page="[[page]]"
      home-page-active="{{homePageActive}}"
      entrepreneur-page-active="{{entrepreneurLandingPageActive}}"
      invest-page-active="{{investorLandingPageActive}}"
    ></placetobe-header>

    <div id="hero-wrapper" hidden$="[[!landingPageActive]]">
      
      <placetobe-hero
        car-parked$="[[investorLandingPageActive]]"
        car-gone$="[[entrepreneurLandingPageActive]]"
        >

        <main slot="main">

          <iron-pages selected="[[page]]" attr-for-selected="name" selected-attribute="visible">
            
            <span name="home">
              <h2>Iedereen heeft een plek nodig. <strong>Een plek om te wonen</strong>, werken, ondernemen, relaxen... Een plek om te zijn.</h2>      
              <placetobe-button
                href="/start-project"
                on-tap="_handleTapStartProjectButton"
                ><span>Hoe start ik een project?</span></placetobe-button>
              <placetobe-button
                href="/investeren"
                on-tap="_handleTapInvestorInfoButton"
                 link><span>Info voor investeerders</span></placetobe-button>
            </span>

            <span name="start-project">
              <h2><strong>Geen gebouw neerzetten, maar een plek maken.</strong> Vastgoed ontwikkel je samen met de crowd.</h2>
              <placetobe-mailinglist-subscribe-form
                api-endpoint="[[apiEndpoint]]"
                user-role="entrepreneurs"
                button-label="Email mij de brochure"
                on-subscribing="_handleEntrepreneursBrochureRequesting"
                on-subscribed="_handleEntrepreneursBrochureRequested"
                on-subscribe-error="_handleEntrepreneursBrochureRequestError"
              ></placetobe-mailinglist-subscribe-form>
            </span>

            <span name="investeren">
              <h2><strong>Crowdfunding in vastgoed.</strong><br>Iedereen een plek en jij rendement.</h2>      
              <placetobe-mailinglist-subscribe-form
                api-endpoint="[[apiEndpoint]]"
                user-role="investors"
                button-label="Email mij de brochure"
                on-subscribing="_handleInvestorsBrochureRequesting"
                on-subscribed="_handleInvestorsBrochureRequested"
                on-subscribe-error="_handleInvestorsBrochureRequestError"
              ></placetobe-mailinglist-subscribe-form> 
            </span>

          </iron-pages>

        </main>

      </placetobe-hero>

    </div>

    <iron-pages selected="[[page]]" attr-for-selected="name" selected-attribute="visible">
      <placetobe-home-page name="home"></placetobe-home-page>
      <placetobe-investeren-page name="investeren"></placetobe-investeren-page>
      <placetobe-start-project-page name="start-project"></placetobe-start-project-page>
      <placetobe-tarieven-page name="tarieven"></placetobe-tarieven-page>
      <placetobe-klachtenprocedure-page name="klachtenprocedure"></placetobe-klachtenprocedure-page>
      <placetobe-algemene-voorwaarden-page name="algemene-voorwaarden"></placetobe-algemene-voorwaarden-page>
    </iron-pages>

    <placetobe-footer></placetobe-footer>

  </template>

  <script>
    Polymer({

      is: 'placetobe-app',

      properties: {

        apiEndpoint: {
          type: String
        },

        campaignId: {
          type: String
        },

        analyticsTrackingId: {
          type: String
        },

        locationPath: {
          type: String
        },

        route: {
          type: Object
        },

        routeData: {
          type: Object,
          value: {}
        },

        page: {
          type: String,
          value: null,
          observer: '_pageChanged'
        },

        apiEndpoint: {
          type: String,
          value: null
        },

        cookiesAccepted: {
          type: Boolean,
          value: false
        },

        scrollY: {
          type: String,
          value: 0,
          readOnly: true
        },

        headerCollapsed: {
          type: Boolean,
          computed: "_computeHeaderCollapsed(scrollY)",
          reflectToAttribute: true          
        },

        investorQuickscanActive: {
          type: Boolean,
          value: false
        },

        landingPageActive: {
          type: Boolean,
          computed: '_computeLandingPageActive(page)'
        },

        investorLandingPageActive: {
          type: Boolean,
          computed: '_computePageIsActive(\'investeren\', page)'
        },

        entrepreneurLandingPageActive: {
          type: Boolean,
          computed: '_computePageIsActive(\'start-project\', page)'
        }

      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      ready: function() {
        this.cookiesAccepted = window.localStorage.getItem('placetobe-cookies-accepted');
        window.addEventListener('scroll', this._handleScroll.bind(this), this._clientSupportsPassiveEvents() ? { passive: true } : false);
      },

      attached: function() {
        Polymer.AppMetadata.requestAvailability();
      },

      _computeLandingPageActive: function(page) {
        return ['home', 'investeren', 'start-project'].indexOf(page) !== -1;
      },

      _computePageIsActive: function(page, currentPage) {
        return (page == currentPage);
      },

      _routePageChanged: function(page) {
        this.page = page || 'home';
      },

      _pageChanged: function(page, oldPage) {
        if(!page) page = 'home';
        var pageUrl = 'placetobe-' + page + '-page.html';
        this.importHref(
          this.resolveUrl(pageUrl),
          function() {
            window.scrollTo(0,0);
            this._sendAnalyticsPage();
            this._setMetaData();
          }, null, true
        );
      },

      _handleScroll: function() {
        this._setScrollY(window.scrollY || document.documentElement.scrollTop);
      },

      _computeHeaderCollapsed: function(scrollY) {
        return (scrollY > 54)
      },

      _clientSupportsPassiveEvents: function() {
        var supportsPassive = false;
        try {
          var opts = Object.defineProperty({}, 'passive', {
            get: function() {
              supportsPassive = true;
            }
          });
          window.addEventListener('test', null, opts);
        }
        catch (e) {}
        finally {
          return supportsPassive;
        }
      },

      _setMetaData: function() {
        console.log('this.locationPath', this.locationPath)
        switch(this.locationPath) {
          default:
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Vastgoed crowdfunding')
            });
            break;
          case "/investeren":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Investeren in vastgoed')
            });
            break;
          case "/investeren/test":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Quickscan investeerders')
            });
            break;
          case "/investeren/aanmelden":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Aanmelden als investeerder')
            });
            break;
          case "/start-project":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Start een project')
            });
            break;
          case "/tarieven":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Tarieven')
            });
            break;
          case "/klachtenprocedure":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('klachtenprocedure')
            });
            break;
        }
      },

      _parseDocumentTitle: function(pageTitle) {
        return [pageTitle, "Placetobe"].join(" | ");
      },

      _sendAnalyticsPage: function() {
        this.fire('iron-signal', {
          name: 'send-page',
          data: {
            path: this.locationPath
          }
        });
      },

      //source, action, category, value
      _sendAnalyticsEvent: function(source, action, category, value) {
        this.fire('iron-signal', {
          name: 'send-event',
          data: {
            category: category,
            action: action,
            label: source,
            value: value || null
          }
        });
      }

    });
  </script>
</dom-module>
