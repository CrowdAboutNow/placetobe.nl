<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="placetobe-config.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-metadata/app-metadata.html" async>
<link rel="import" href="../../bower_components/placetobe-styles/placetobe-styles.html">
<link rel="import" href="../../bower_components/placetobe-behaviors/placetobe-styles-behavior.html">
<link rel="import" href="../../bower_components/placetobe-cookie-warning/placetobe-cookie-warning.html" async>
<link rel="import" href="../../bower_components/placetobe-card/placetobe-card.html" async>
<link rel="import" href="../../bower_components/placetobe-header/placetobe-header.html">
<link rel="import" href="../../bower_components/placetobe-footer/placetobe-footer.html" async>
<link rel="import" href="../../bower_components/placetobe-route/placetobe-route.html">
<link rel="import" href="../../bower_components/placetobe-hero/placetobe-hero.html" async>
<link rel="import" href="../../bower_components/placetobe-illustrations/placetobe-illustrations.html">
<link rel="import" href="../../bower_components/placetobe-popup/placetobe-popup.html" async>
<link rel="import" href="../../bower_components/placetobe-mailinglist-subscribe-form/placetobe-mailinglist-subscribe-form.html" async>
<link rel="import" href="../../bower_components/placetobe-survey/placetobe-investor-quickscan.html" async>
<link rel="import" href="../../bower_components/placetobe-survey/placetobe-entrepreneur-quickscan.html">

<dom-module id="placetobe-app">
  <template>

    <style>

      :host {
        --placetobe-color--general: var(--placetobe-color-gray);
        --placetobe-color--entrepreneurs: var(--placetobe-color-yellow);
        --placetobe-color--investors: var(--placetobe-color-taupe);
/*        --placetobe-header-tint-active-color: var(--placetobe-color-green);
        --placetobe-header-active-color: var(--placetobe-color-red);
*/      }

      :host placetobe-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 9;
      }

      :host placetobe-hero {
        height: 0;
        min-height: calc( var(--placetobe-margin) * 26 );
      }

      @media(min-width: 601px) {
        :host placetobe-hero {
          min-height: 60vh;
        }
      }

      #hero-wrapper {
        overflow: hidden;
        height: 0;
        min-height: calc( var(--placetobe-margin) * 26 );
        transition: 0.6s min-height;
        transform: translate3d(0,0,0);
      }

      @media(min-width: 601px) {
        :host #hero-wrapper {
          min-height: 60vh;
        }
      }

      #hero-wrapper[hidden] {
        min-height: 0;
        display: block;
      }

      :host placetobe-hero[car-parked] {
        --placetobe-hero-color: var(--placetobe-color-taupe);
      }

      :host placetobe-hero[car-gone] {
        --placetobe-hero-color: var(--placetobe-color-yellow);
      }

      :host .horizontal-layout {
        @apply(--placetobe-border-box);
        @apply(--placetobe-flex-layout--vertical);
        @apply(--placetobe-flex-align--space-between);
        @apply(--placetobe-cross-align--baseline);
        max-width: calc( var(--placetobe-layout-width) + (var(--placetobe-margin) * 2) );
        padding: 0 calc(var(--placetobe-margin));
        margin-left: auto;
        margin-right: auto;
      }

      :host .horizontal-layout > * {
        width: 100%;
      }

      @media (min-width: 601px) {

        :host .horizontal-layout {
          @apply(--placetobe-flex-layout--horizontal);
          @apply(--placetobe-flex-align--center);
        }
        
        :host .horizontal-layout > *:not(.layout-66-33--item-1) {
          @apply(--placetobe-flex-item--1);
        }

        :host .horizontal-layout.layout-50-50 > *:nth-child(1) {
          padding-right: 12px;
        }        

        :host .horizontal-layout.layout-50-50 > *:nth-child(2) {
          padding-left: 12px;
        }        

/*        :host .horizontal-layout.layout-50-50 * >:nth-child(1) {
          padding: 0 6px;
        }        
*/
        :host .layout-66-33--item-1 {
          @apply(--placetobe-flex-item--2);
          max-width: calc(66.66666% - 12px);
          padding-right: 18px;
        }

        :host .layout-66-33--item-2 > *:nth-child(2) {
          @apply(--placetobe-flex-item--1);
          max-width: calc(33.333333% - 12px);
        }

      }

      :host article {
        @apply(--placetobe-font-body);
        padding: auto;
      }

      :host article p:first-child {
        padding-top: var(--placetobe-margin);
        @apply(--placetobe-font-body-bold);
      }

      :host main {
        font-size: 0;
        margin-bottom: -10px;
      }

      :host h1 {
        @apply(--placetobe-font-heading1);
      }

      :host h2 {
        @apply(--placetobe-font-heading1-regular);
      }

      :host #pricing {
        margin-top: calc( var(--placetobe-margin) * 8 );
      }

      placetobe-cookie-warning {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
      }

      placetobe-footer h2 {
        @apply(--placetobe-font-heading3);
        color: white;
      }

      placetobe-card {
        --placetobe-card-color: var(--placetobe-color--general);
      }

      placetobe-card.entrepreneur-card {
        --placetobe-card-color: var(--placetobe-color--entrepreneurs);
      }

      placetobe-card.investor-card {
        --placetobe-card-color: var(--placetobe-color--investors);
      }

      placetobe-hero placetobe-button:not([link]) {
        --placetobe-button-color: white;
      }

    </style>

    <placetobe-config
      api-endpoint="{{apiEndpoint}}"
    ></placetobe-config>

    <template is="dom-if" if="[[!cookiesAccepted]]">
      <placetobe-cookie-warning
        on-cookies-accepted="_handleCookiesAccepted"
      ></placetobe-cookie-warning>
    </template>

    <app-location
      id="appLocation"
      route="{{route}}"
      path="{{locationPath}}"
    ></app-location>

    <placetobe-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
    ></placetobe-route>

    <placetobe-route
      route="{{route}}"
      pattern="/"
      active="{{homePageActive}}"
    ></placetobe-route>

    <placetobe-route
      route="{{route}}"
      pattern="/start-project"
      matches="{{entrepreneurLandingPageActive}}"
      tail="{{entrepreneurSubroute}}"
    ></placetobe-route>

    <placetobe-route
      route="{{entrepreneurSubroute}}"
      pattern="/test"
      active="{{entrepreneurQuickscanActive}}"
    ></placetobe-route>

    <placetobe-route
      route="{{route}}"
      pattern="/investeren"
      tail="{{subroute}}"
      matches="{{investorLandingPageActive}}"
    ></placetobe-route>

    <placetobe-route
      route="{{subroute}}"
      pattern="/test"
      active="{{investorQuickscanActive}}"
    ></placetobe-route>

    <placetobe-header
      location-path="{{locationPath}}"
      collapsed="[[headerCollapsed]]"
      current-page="[[routeData.page]]"
      home-page-active="{{homePageActive}}"
      entrepreneur-page-active="{{entrepreneurLandingPageActive}}"
      invest-page-active="{{investorLandingPageActive}}"
      pricing-page-active="{{pricingPageActive}}"
    ></placetobe-header>

    <div id="hero-wrapper" hidden$="[[!landingPageActive]]">
      <placetobe-hero
        car-parked$="[[investorLandingPageActive]]"
        car-gone$="[[entrepreneurLandingPageActive]]"
        >

        <main slot="main">

          <span hidden$="[[!homePageActive]]">
            <h2>Iedereen heeft een plek nodig. <strong>Een plek om te wonen</strong>, werken, ondernemen, relaxen... Een plek om te zijn.</h2>      
            <placetobe-button href="/start-project"><span>Hoe start ik een project?</span></placetobe-button>
            <placetobe-button href="/investeren" link><span>Info voor investeerders</span></placetobe-button>
          </span>f
          
          <span hidden$="[[!entrepreneurLandingPageActive]]">
            <h2><strong>Geen gebouw neerzetten, maar een plek maken.</strong> Vastgoed ontwikkel je samen met de crowd.</h2>
            <placetobe-mailinglist-subscribe-form
              api-endpoint="[[apiEndpoint]]"
              user-role="entrepreneurs"
              button-label="Email mij de brochure"
            ></placetobe-mailinglist-subscribe-form>
          </span>
          
          <span hidden$="[[!investorLandingPageActive]]">
            <h2><strong>Crowdfunding in vastgoed.</strong><br>Iedereen een plek en jij rendement.</h2>      
            <placetobe-mailinglist-subscribe-form
              api-endpoint="[[apiEndpoint]]"
              user-role="investors"
              button-label="Email mij de brochure"
            ></placetobe-mailinglist-subscribe-form> 
          </span>
          
        </main>

        <placetobe-manholdingkey-illustration slot="illustration" hidden$="[[!homePageActive]]"></placetobe-manholdingkey-illustration>
        <placetobe-manreading-illustration slot="illustration" hidden$="[[!entrepreneurLandingPageActive]]"></placetobe-manreading-illustration>
        <placetobe-manthinking-illustration slot="illustration" hidden$="[[!investorLandingPageActive]]"></placetobe-manthinking-illustration>
        
      </placetobe-hero>
    </div>


    <template is="dom-if" if="[[landingPageActive]]">

      <template is="dom-if" if="[[homePageActive]]">
        <placetobe-home-landing-page></placetobe-home-landing-page>
      </template>

      <template is="dom-if" if="[[entrepreneurLandingPageActive]]">
        <placetobe-entrepreneur-landing-page
          api-endpoint="[[apiEndpoint]]"
        ></placetobe-entrepreneur-landing-page>
      </template>

      <template is="dom-if" if="[[investorLandingPageActive]]">
        <placetobe-investor-landing-page
          api-endpoint="[[apiEndpoint]]"
        ></placetobe-investor-landing-page>
      </template>

    </template>


    <template is="dom-if" if="[[pricingPageActive]]">
      <placetobe-pricing-page></placetobe-pricing-page>
    </template>

    <placetobe-footer></placetobe-footer>

        <placetobe-popup
          with-backdrop
          opened$="[[investorQuickscanActive]]"
          on-iron-overlay-closed="_handleCloseInvestorQuickscan"
          >
          <placetobe-investor-quickscan>
            <placetobe-mailinglist-subscribe-form
              api-endpoint="[[apiEndpoint]]"
              user-role="investors"
              button-label="Email brochure"
              slot="action"
            ></placetobe-mailinglist-subscribe-form>
          </placetobe-investor-quickscan>        
        </placetobe-popup>

        <placetobe-popup
          with-backdrop
          opened$="[[entrepreneurQuickscanActive]]"
          on-iron-overlay-closed="_handleCloseEntrepreneurQuickscan"
          >
          <placetobe-entrepreneur-quickscan>
            <placetobe-mailinglist-subscribe-form
              api-endpoint="[[apiEndpoint]]"
              user-role="entrepreneurs"
              button-label="Email brochure"
              slot="action"
            ></placetobe-mailinglist-subscribe-form>
          </placetobe-entrepreneur-quickscan>        
        </placetobe-popup>

  </template>

  <script>
    Polymer({

      is: 'placetobe-app',

      properties: {

        apiEndpoint: {
          type: String
        },

        route: {
          type: Object,
          observer: "routeChanged"
        },

        routeData: {
          type: Object,
          value: {}
        },

        subroute: {
          type: Object,
          value: {}
        },

        subrouteData: {
          type: Object,
          value: {}
        },

        homePageActive: {
          type: Boolean,
          value: false,
          observer: '_homePageActiveChanged'
        },

        entrepreneurLandingPageActive: {
          type: Boolean,
          value: false,
          observer: '_entrepreneurLandingPageActiveChanged'
        },

        investorLandingPageActive: {
          type: Boolean,
          value: false,
          observer: '_investorLandingPageActiveChanged'
        },

        campaignPageActive: {
          type: Boolean,
          value: false
        },

        headerCollapsed: {
          type: Boolean,
          computed: "_computeHeaderCollapsed(scrollY)",
          reflectToAttribute: true          
        },

        landingPageActive: {
          type: Boolean,
          computed: '_computeLandingPageActive(homePageActive, investorLandingPageActive, entrepreneurLandingPageActive, routeData.*, subrouteData.*)'
        },

        pricingPageActive: {
          type: Boolean,
          computed: '_computePricingPageActive(routeData.page)',
          observer: '_pricingPageActiveChanged'
        },

        apiEndpoint: {
          type: String,
          value: null
        },

        cookiesAccepted: {
          type: Boolean,
          value: false
        },

        scrollY: {
          type: String,
          value: 0,
          readOnly: true
        },

        entrepreneurQuickscanActive: {
          type: Boolean,
          value: false
        },

        investorQuickscanActive: {
          type: Boolean,
          value: false
        }

      },

      observers: [
        "_setMetaData(route.path)"
      ],

      ready: function() {
        this.routeChanged();
        this.cookiesAccepted = window.localStorage.getItem('placetobe-cookies-accepted');
        window.addEventListener('scroll', this._handleScroll.bind(this));
      },

      attached: function() {
        Polymer.AppMetadata.requestAvailability();
        this._setMetaData();
      },

      routeChanged: function(newRoute, oldRoute) {
        window.scrollTo(0,0)
        var routeExists = (newRoute || {path:""}).path.match(/^(\/(start-project|investeren|tarieven|campagnes)(|\/test|\/aanmelden)|(\/|))$/g);
        if(!routeExists) history.replaceState({}, "Placetobe", "/");
        if(!(newRoute && oldRoute)) return;
        if(newRoute.path !== oldRoute.path) this._handleRouteChanged(newRoute.path, oldRoute.path);
      },

      _handleScroll: function() {
        this._setScrollY(window.scrollY || document.documentElement.scrollTop);
      },

      _computeHeaderCollapsed: function(scrollY) {
        return (scrollY > 54)
      },

      _handleRouteChanged: function(newPath, oldPath) {
        this.fire('app-metadata', {
          title: 'This is the page title',
          description: 'This is the page description',
          keywords: 'these,are,keywords'
        });
      },

      _handleCookiesAccepted: function() {
        window.localStorage.setItem('placetobe-cookies-accepted', true);
        this.cookiesAccepted = window.localStorage.getItem('placetobe-cookies-accepted');
      },

      _setMetaData: function(path) {
        switch(this.route.path) {
          default:
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Vastgoed crowdfunding'),
              description: 'Dé plek voor het crowdfunden van vastgoed in Nederland.'
            });
            break;
          case "/investeren":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Investeren in vastgoed'),
              description: 'De betrouwbaarste vorm van beleggen. Gebruiksvriendelijk. Veilig. Samen.'
            });
            break;
          case "/investeren/test":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Quickscan investeerders'),
              description: 'Beantwoord 5 vragen en vind uit of jij een vastgoed crowdfunder bent.'
            });
            break;
          case "/investeren/aanmelden":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Aanmelden als investeerder'),
              description: 'Dé plek voor het crowdfunden van vastgoed in Nederland.'
            });
            break;
          case "/start-project":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Start een project'),
              description: 'Wij helpen je de crowdfunders te vinden voor jouw vastgoedproject.'
            });
            break;
          case "/tarieven":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Tarieven'),
              description: 'We begeleiden het hele proces en geven je advies over campagne voeren en hoe je betrokken investeerders vindt.'
            });
            break;
        }
      },

      _parseDocumentTitle: function(pageTitle) {
        return [pageTitle, "Placetobe"].join(" | ");
      },

      _computeLandingPageActive: function(homePageActive, investorLandingPageActive, entrepreneurLandingPageActive, routedataitem, subroutedataitem) {
        var landingPageActive = ((homePageActive || investorLandingPageActive || entrepreneurLandingPageActive) && (!subroutedataitem.base.subpage));
        return landingPageActive;
      },

      _computePricingPageActive: function(page) {
        return (page == 'tarieven');
      },

      _handleOpenInvestorQuickscan: function(evt) {
        this.$.appLocation.path = '/investeren/test';
      },

      _handleCloseInvestorQuickscan: function(evt) {
        this.$.appLocation.path = '/investeren';
      },

      _handleOpenEntrepreneurQuickscan: function(evt) {
        this.$.appLocation.path = '/start-project/test';
      },

      _handleCloseEntrepreneurQuickscan: function(evt) {
        this.$.appLocation.path = '/start-project';        
      },

      _homePageActiveChanged: function(homePageActive) {
        this._loadElement(homePageActive, 'placetobe-home-landing-page.html', function() {
          this._loadLandingPages();
        })
      },

      _entrepreneurLandingPageActiveChanged: function(entrepreneurLandingPageActive) {
        this._loadElement(entrepreneurLandingPageActive, 'placetobe-entrepreneur-landing-page.html', function() {
          this._loadLandingPages();
        })
      },

      _investorLandingPageActiveChanged: function(investorLandingPageActive) {
        this._loadElement(investorLandingPageActive, 'placetobe-investor-landing-page.html', function() {
          this._loadLandingPages();
        })
      },

      _pricingPageActiveChanged: function(pricingPageActive) {
        this._loadElement(pricingPageActive, 'placetobe-pricing-page.html', function() {
          this._loadLandingPages();
        })
      },

      _loadElement(doLoad, url, callback) {
        if(!doLoad) return;
        this.importHref(this.resolveUrl(url), callback || function() {});
      },

      _loadLandingPages: function() {
        this._loadElement(true, 'placetobe-home-landing-page.html');
        this._loadElement(true, 'placetobe-investor-landing-page.html');
        this._loadElement(true, 'placetobe-entrepreneur-landing-page.html');
        this._loadElement(true, 'placetobe-pricing-page.html');
      }

    });
  </script>
</dom-module>
