<link
  rel="import"
  href="../../bower_components/polymer/polymer.html"
>

<link
  rel="import"
  href="../../bower_components/app-route/app-location.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-route/placetobe-route.html"
>

<link
  rel="import"
  href="../../bower_components/app-metadata/app-metadata.html"
  async
>

<link
  rel="import"
  href="../../bower_components/google-analytics-tracker/google-analytics-tracker.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-styles/placetobe-styles.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-behaviors/placetobe-styles-behavior.html"
>

<link
  rel="import"
  href="../../bower_components/iron-pages/iron-pages.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-hero/placetobe-hero.html"
>

<link
  rel="import"
  href="../../bower_components/placetobe-button/placetobe-button.html"
  async
>

<link
  rel="import"
  href="../../bower_components/placetobe-header/placetobe-header.html"
  async
>

<link
  rel="import"
  href="../../bower_components/placetobe-footer/placetobe-footer.html"
  async
>

<link
  rel="import"
  href="../../bower_components/placetobe-illustrations/placetobe-future-illustration.html"
  async
>

<link
  rel="import"
  href="../../bower_components/placetobe-illustrations/placetobe-impact-illustration.html"
  async
>

<link
  rel="import"
  href="../../bower_components/placetobe-illustrations/placetobe-support-illustration.html"
  async
>

<link
  rel="import"
  href="../../bower_components/placetobe-popup/placetobe-popup.html"
  async
>

 <link
  rel="import"
  href="../../bower_components/placetobe-mailinglist-subscribe-form/placetobe-mailinglist-subscribe-form.html"
  async
>
 
<link
  rel="import"
  href="../../bower_components/placetobe-survey/placetobe-investor-quickscan.html"
  async
>

<link
  rel="import"
  href="../../bower_components/placetobe-survey/placetobe-entrepreneur-quickscan.html"
  async
>

<link
  rel="import"
  href="../../bower_components/placetobe-cookie-warning/placetobe-cookie-warning.html"
  async
>

<link
  rel="import"
  href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html"
  async
>

<dom-module id="placetobe-app">
  <template>

    <style>

      :host {
        --placetobe-color--general: var(--placetobe-color-gray);
        --placetobe-color--entrepreneurs: var(--placetobe-color-yellow);
        --placetobe-color--investors: var(--placetobe-color-taupe);
      }

      :host placetobe-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 9;
      }

      :host placetobe-hero {
        height: 0;
        min-height: 80vh;
      }

      @media(min-width: 1441px) {
        :host placetobe-hero {
          min-height: 60vh;
        }
      }

      #hero-wrapper {
        overflow: hidden;
        height: 0;
        min-height: 80vh;
        transition: 0.6s min-height;
        transform: translate3d(0,0,0);
      }

      @media(min-width: 1441px) {
        :host #hero-wrapper {
          min-height: 60vh;
        }
      }

      #hero-wrapper[hidden] {
        min-height: 0;
        display: block;
      }

      placetobe-hero[car-parked] {
        --placetobe-hero-color: var(--placetobe-color-taupe);
      }

      placetobe-hero[car-gone] {
        --placetobe-hero-color: var(--placetobe-color-yellow);
      }

      placetobe-cookie-warning {
        position: fixed;
        z-index: 8;
        bottom: 0;
        left: 0;
        right: 0;
      }
    </style>

    <google-analytics-tracker
      tracking-id="[[analyticsTrackingId]]"
    ></google-analytics-tracker>

    <app-localstorage-document
      key="user-status"
      data="{{user}}"
    ></app-localstorage-document>

    <app-location
      route="{{route}}"
      path="{{locationPath}}"
    ></app-location>

    <placetobe-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subRoute}}"
    ></placetobe-route>

    <placetobe-route
      route="{{subRoute}}"
      pattern="/:page"
      data="{{subRouteData}}"
    ></placetobe-route>

    <placetobe-header
      location-path="{{locationPath}}"
      collapsed="[[headerCollapsed]]"
      current-page="[[page]]"
      home-page-active="{{homePageActive}}"
      entrepreneur-page-active="{{entrepreneurLandingPageActive}}"
      invest-page-active="{{investorLandingPageActive}}"
    ></placetobe-header>

    <div id="hero-wrapper" hidden$="[[!landingPageActive]]">
      
      <placetobe-hero
        >

        <main slot="main">

            
          <span hidden$="[[!homePageActive]]">
            <h2><strong>Positieve impact</strong> met vastgoed?</h2>      
            <placetobe-button
              href="/start-project"
              on-tap="_handleTapStartProjectButton"
              ><span>Hoe start ik een project?</span></placetobe-button>
            <placetobe-button
              href="/investeren"
              on-tap="_handleTapInvestorInfoButton"
               link><span>Info voor investeerders</span></placetobe-button>
          </span>

          <span hidden$="[[!entrepreneurLandingPageActive]]">
            <h2><strong>Financiering</strong> Ã©n draagvlak?</h2>
            <placetobe-mailinglist-subscribe-form
              api-endpoint="[[apiEndpoint]]"
              user-role="entrepreneurs"
              button-label="Email mij de brochure"
              on-subscribing="_handleEntrepreneursBrochureRequesting"
              on-subscribed="_handleEntrepreneursBrochureRequested"
              on-subscribe-error="_handleEntrepreneursBrochureRequestError"
            ></placetobe-mailinglist-subscribe-form>
          </span>

          <span hidden$="[[!investorLandingPageActive]]">
            <h2><strong>Bouwen</strong> aan de toekomst?</h2>      
            <placetobe-mailinglist-subscribe-form
              api-endpoint="[[apiEndpoint]]"
              user-role="investors"
              button-label="Email mij de brochure"
              on-subscribing="_handleInvestorsBrochureRequesting"
              on-subscribed="_handleInvestorsBrochureRequested"
              on-subscribe-error="_handleInvestorsBrochureRequestError"
            ></placetobe-mailinglist-subscribe-form> 
          </span>


        </main>

        <placetobe-impact-illustration
          slot="illustration"
          hidden$="[[!homePageActive]]"
        ></placetobe-impact-illustration>

        <placetobe-future-illustration
          slot="illustration"
          hidden$="[[!entrepreneurLandingPageActive]]"
        ></placetobe-future-illustration>

        <placetobe-support-illustration
          slot="illustration"
          hidden$="[[!investorLandingPageActive]]"
        ></placetobe-support-illustration>

      </placetobe-hero>

    </div>

    <iron-pages selected="[[page]]" attr-for-selected="name" selected-attribute="visible">
      <placetobe-home-page name="home"></placetobe-home-page>
      <placetobe-investeren-page name="investeren"></placetobe-investeren-page>
      <placetobe-start-project-page name="start-project"></placetobe-start-project-page>
      <placetobe-tarieven-page name="tarieven"></placetobe-tarieven-page>
      <placetobe-klachtenprocedure-page name="klachtenprocedure"></placetobe-klachtenprocedure-page>
      <placetobe-algemene-voorwaarden-page name="algemene-voorwaarden"></placetobe-algemene-voorwaarden-page>
      <placetobe-campagnes-page api-endpoint="[[apiEndpoint]]" campaign-route="[[subRoute]]" name="campagnes" user="[[user]]" invoice-number="[[invoiceNumber]]"></placetobe-campagnes-page>
    </iron-pages>

    <placetobe-footer></placetobe-footer>

    <placetobe-popup
      with-backdrop
      opened="[[investorQuickscanActive]]"
      on-popup-closed="_handleCloseInvestorQuickscan"
      >
      <placetobe-investor-quickscan
        on-question-answered="_handleInvestorQuickscanQuestionAnswered"
        on-finished="_handleInvestorQuickscanFinished"
      >
        <placetobe-mailinglist-subscribe-form
          api-endpoint="[[apiEndpoint]]"
          user-role="investors"
          button-label="Email brochure"
          on-subscribing="_handleInvestorsBrochureRequestingViaQuickscan"
          on-subscribed="_handleInvestorsBrochureRequestedViaQuickscan"
          on-subscribe-error="_handleInvestorsBrochureRequestErrorViaQuickscan"
          slot="action"
        ></placetobe-mailinglist-subscribe-form>
      </placetobe-investor-quickscan>        
    </placetobe-popup>

    <placetobe-popup
      with-backdrop
      opened="[[entrepreneurQuickscanActive]]"
      on-popup-closed="_handleCloseEntrepreneurQuickscan"
      >
      <placetobe-entrepreneur-quickscan
        on-question-answered="_handleEntrepreneurQuickscanQuestionAnswered"
        on-finished="_handleEntrepreneurQuickscanFinished"
      >
        <placetobe-mailinglist-subscribe-form
          api-endpoint="[[apiEndpoint]]"
          user-role="entrepreneurs"
          button-label="Email brochure"
          on-subscribing="_handleEntrepreneursBrochureRequestingViaQuickscan"
          on-subscribed="_handleEntrepreneursBrochureRequestedViaQuickscan"
          on-subscribe-error="_handleEntrepreneursBrochureRequestErrorViaQuickscan"
          slot="action"
        ></placetobe-mailinglist-subscribe-form>
      </placetobe-entrepreneur-quickscan>        
    </placetobe-popup>

    <template is="dom-if" if="[[!cookiesAccepted]]">
      <placetobe-cookie-warning
        on-cookies-accepted="_handleCookiesAccepted"
      ></placetobe-cookie-warning>
    </template>

  </template>

  <script>
    Polymer({

      is: 'placetobe-app',

      properties: {

        apiEndpoint: {
          type: String
        },

        campaignId: {
          type: String
        },

        analyticsTrackingId: {
          type: String
        },

        locationPath: {
          type: String
        },

        route: {
          type: Object
        },

        routeData: {
          type: Object,
          value: {}
        },

        subRoute: {
          type: Object
        },

        subRouteData: {
          type: Object,
          value: {}
        },
        /* 
        * Number of invoice of succesful investment propogated via POST request body (server.js -> index.hbs -> placetobe-app)
        */
        invoiceNumber: {
          type: String
        },

        page: {
          type: String,
          value: null,
          observer: '_pageChanged'
        },

        apiEndpoint: {
          type: String,
          value: null
        },

        cookiesAccepted: {
          type: Boolean,
          value: false
        },

        scrollY: {
          type: String,
          value: 0,
          readOnly: true
        },

        headerCollapsed: {
          type: Boolean,
          computed: "_computeHeaderCollapsed(scrollY)",
          reflectToAttribute: true          
        },

        entrepreneurQuickscanActive: {
          type: Boolean,
          computed: '_computeEntrepreneurQuickscanActive(routeData.*, subRouteData.*)'
        },

        investorQuickscanActive: {
          type: Boolean,
          computed: '_computeInvestorQuickscanActive(routeData.*, subRouteData.*)'
        },

        landingPageActive: {
          type: Boolean,
          computed: '_computeLandingPageActive(page)'
        },

        homePageActive: {
          type: Boolean,
          computed: '_computePageIsActive(\'home\', page)'
        },

        investorLandingPageActive: {
          type: Boolean,
          computed: '_computePageIsActive(\'investeren\', page)'
        },

        entrepreneurLandingPageActive: {
          type: Boolean,
          computed: '_computePageIsActive(\'start-project\', page)'
        },
        /*
        * Information on authentication status of site visitor. 
        * Is also obtained from localstorage.
        */ 
        user: {
          type: Object,
          value: {}
        } 
      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      ready: function() {
        this.cookiesAccepted = window.localStorage.getItem('placetobe-cookies-accepted');
        window.addEventListener('scroll', this._handleScroll.bind(this), this._clientSupportsPassiveEvents() ? { passive: true } : false);
      },

      attached: function() {
        Polymer.AppMetadata.requestAvailability();
      },

      _computeLandingPageActive: function(page) {
        return ['home', 'investeren', 'start-project'].indexOf(page) !== -1;
      },

      _computePageIsActive: function(page, currentPage) {
        return (page == currentPage);
      },

      _routePageChanged: function(page) {
        this.page = page || 'home';
      },

      _pageChanged: function(page, oldPage) {
        if(!page) page = 'home';
        var pageUrl = 'placetobe-' + page + '-page.html';
        this.importHref(
          this.resolveUrl(pageUrl),
          function() {
            window.scrollTo(0,0);
            this._sendAnalyticsPage();
            this._setMetaData();
          }, null, true
        );
      },     
      
      _handleScroll: function() {
        this._setScrollY(window.scrollY || document.documentElement.scrollTop);
      },

      _computeHeaderCollapsed: function(scrollY) {
        return (scrollY > 54)
      },

      _computeEntrepreneurQuickscanActive: function(routeChange, subRouteChange) {
        return (routeChange.base.page == 'start-project' && subRouteChange.base.page == 'test')
      },

      _computeInvestorQuickscanActive: function(routeChange, subRouteChange) {
        return (routeChange.base.page == 'investeren' && subRouteChange.base.page == 'test')
      },

      _clientSupportsPassiveEvents: function() {
        var supportsPassive = false;
        try {
          var opts = Object.defineProperty({}, 'passive', {
            get: function() {
              supportsPassive = true;
            }
          });
          window.addEventListener('test', null, opts);
        }
        catch (e) {}
        finally {
          return supportsPassive;
        }
      },

      _setMetaData: function() {
        switch(this.locationPath) {
          default:
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Vastgoed crowdfunding')
            });
            break;
          case "/investeren":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Investeren in vastgoed')
            });
            break;
          case "/investeren/test":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Quickscan investeerders')
            });
            break;
          case "/investeren/aanmelden":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Aanmelden als investeerder')
            });
            break;
          case "/start-project":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Start een project')
            });
            break;
          case "/tarieven":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('Tarieven')
            });
            break;
          case "/klachtenprocedure":
            this.fire('app-metadata', {
              title: this._parseDocumentTitle('klachtenprocedure')
            });
            break;
        }
      },

      _parseDocumentTitle: function(pageTitle) {
        return [pageTitle, "Placetobe"].join(" | ");
      },

      _handleOpenInvestorQuickscan: function(evt) {
        this.locationPath = '/investeren/test';
      },

      _handleCloseInvestorQuickscan: function(evt) {
        this.locationPath = '/investeren';
      },

      _handleOpenEntrepreneurQuickscan: function(evt) {
        this.locationPath = '/start-project/test';
      },

      _handleCloseEntrepreneurQuickscan: function(evt) {
        this.locationPath = '/start-project';        
      },

      _sendAnalyticsPage: function() {
        this.fire('iron-signal', {
          name: 'send-page',
          data: {
            path: this.locationPath
          }
        });
      },

      //source, action, category, value
      _sendAnalyticsEvent: function(source, action, category, value) {
        this.fire('iron-signal', {
          name: 'send-event',
          data: {
            category: category,
            action: action,
            label: source,
            value: value || null
          }
        });
      },

      _handleEntrepreneursBrochureRequesting: function() {
        this._sendAnalyticsEvent('hero', 'requesting', 'entrepreneurs-brochure')
      },

      _handleEntrepreneursBrochureRequested: function() {
        this._sendAnalyticsEvent('hero', 'requested', 'entrepreneurs-brochure')
      },

      _handleEntrepreneursBrochureRequestError: function() {
        this._sendAnalyticsEvent('hero', 'request-error', 'entrepreneurs-brochure')
      },

      _handleEntrepreneursBrochureRequestingViaQuickscan: function() {
        this._sendAnalyticsEvent('entrepreneurs-quickscan', 'requesting', 'entrepreneurs-brochure')
      },

      _handleEntrepreneursBrochureRequestedViaQuickscan: function() {
        this._sendAnalyticsEvent('entrepreneurs-quickscan', 'requested', 'entrepreneurs-brochure')
      },

      _handleEntrepreneursBrochureRequestErrorViaQuickscan: function() {
        this._sendAnalyticsEvent('entrepreneurs-quickscan', 'request-error', 'entrepreneurs-brochure')
      },

      _handleInvestorsBrochureRequesting: function() {
        this._sendAnalyticsEvent('hero', 'requesting', 'investors-brochure')
      },

      _handleInvestorsBrochureRequested: function() {
        this._sendAnalyticsEvent('hero', 'requested', 'investors-brochure')
      },

      _handleInvestorsBrochureRequestError: function() {
        this._sendAnalyticsEvent('hero', 'request-error', 'investors-brochure')
      },

      _handleInvestorsBrochureRequestingViaQuickscan: function() {
        this._sendAnalyticsEvent('investors-quickscan', 'requesting', 'investors-brochure')
      },

      _handleInvestorsBrochureRequestedViaQuickscan: function() {
        this._sendAnalyticsEvent('investors-quickscan', 'requested', 'investors-brochure')
      },

      _handleInvestorsBrochureRequestErrorViaQuickscan: function() {
        this._sendAnalyticsEvent('investors-quickscan', 'request-error', 'investors-brochure')
      },

      _handleTapStartProjectButton: function() {
        this._sendAnalyticsEvent('hero', 'tap', 'start-project-button')
      },

      _handleTapInvestorInfoButton: function() {
        this._sendAnalyticsEvent('hero', 'tap', 'investor-info-button')
      },

      _handleInvestorQuickscanQuestionAnswered: function(evt) {
        this._sendAnalyticsEvent('investors-quickscan', 'question ' + evt.detail.question, 'investors-quickscan', evt.detail.score)
      },

      _handleInvestorQuickscanFinished: function(evt) {
        this._sendAnalyticsEvent('investors-quickscan', 'finished', 'investors-quickscan', evt.detail.totalScore)
      },

      _handleEntrepreneurQuickscanQuestionAnswered: function(evt) {
        this._sendAnalyticsEvent('entrepreneurs-quickscan', 'question ' + evt.detail.question, 'entrepreneurs-quickscan', evt.detail.score)
      },

      _handleEntrepreneurQuickscanFinished: function(evt) {
        this._sendAnalyticsEvent('entrepreneurs-quickscan', 'finished', 'entrepreneurs-quickscan', evt.detail.totalScore)
      },

      _handleCookiesAccepted: function() {
        window.localStorage.setItem('placetobe-cookies-accepted', true);
        this.cookiesAccepted = window.localStorage.getItem('placetobe-cookies-accepted');
      }
    });
  </script>
</dom-module>
